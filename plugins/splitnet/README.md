# SplitNet 插件

SplitNet 是 CoreDNS 的内外网区分解析插件，根据客户端IP类型智能过滤解析结果。

## 功能特性

- **智能分流**: 根据客户端IP是否为内网IP，提供不同的解析结果
- **动态网段**: 支持API动态获取内网网段配置
- **高效过滤**: 使用Trie结构进行快速IP归属判断
- **缓存优化**: LRU缓存减少重复计算，提升性能
- **智能返回**: 优先返回匹配类型的IP，无匹配时返回所有IP

## 智能返回策略

### 内网客户端
- **优先返回**: 内网服务器IP
- **兜底策略**: 如果没有内网IP，返回所有服务器IP

### 外网客户端
- **优先返回**: 外网服务器IP
- **兜底策略**: 如果没有外网IP，返回所有服务器IP

## 配置参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `api_url` | string | - | 内网网段API地址 |
| `api_interval` | duration | 30s | API刷新间隔 |
| `cache_size` | int | 1024 | LRU缓存大小 |

## 配置示例

```corefile
splitnet {
    api_url http://localhost:8080/internal_cidr
    api_interval 30s
    cache_size 1024
}
```

## API 接口

### 内网CIDR获取接口 (`/internal_cidr`)

返回内网网段配置列表：

```json
[
    {
        "cidr": "10.0.0.0/8",
        "desc": "内网A段"
    },
    {
        "cidr": "192.168.0.0/16",
        "desc": "内网C段"
    },
    {
        "cidr": "172.16.0.0/12",
        "desc": "内网B段"
    }
]
```

## 工作流程

1. **获取客户端IP**: 从DNS请求中提取客户端IP地址
2. **判断IP类型**: 使用Trie结构快速判断客户端IP是否为内网IP
3. **分类服务器IP**: 将解析结果中的IP分为内网IP和外网IP
4. **智能选择**: 根据客户端类型选择返回策略
5. **返回结果**: 返回过滤后的DNS解析结果

## 使用场景

### 场景1: 内网客户端访问
- 客户端IP: `192.168.1.100` (内网)
- 服务器IP: `[10.1.2.3, 1.2.3.4]` (内网+外网)
- 返回结果: `[10.1.2.3]` (内网IP)

### 场景2: 内网客户端访问（无内网服务器）
- 客户端IP: `192.168.1.100` (内网)
- 服务器IP: `[1.2.3.4, 5.6.7.8]` (全部外网)
- 返回结果: `[1.2.3.4, 5.6.7.8]` (所有IP)

### 场景3: 外网客户端访问
- 客户端IP: `203.0.113.1` (外网)
- 服务器IP: `[10.1.2.3, 1.2.3.4]` (内网+外网)
- 返回结果: `[1.2.3.4]` (外网IP)

### 场景4: 外网客户端访问（无外网服务器）
- 客户端IP: `203.0.113.1` (外网)
- 服务器IP: `[10.1.2.3, 10.1.2.4]` (全部内网)
- 返回结果: `[10.1.2.3, 10.1.2.4]` (所有IP)

## 性能特性

- **高效查找**: 使用Trie结构进行快速IP归属判断
- **LRU缓存**: 减少重复计算，提升查询性能
- **并发安全**: 使用读写锁保护共享数据
- **热加载**: 配置变更无需重启服务

## 监控指标

- DNS查询总数和延迟
- 内网/外网客户端比例
- 缓存命中率
- API调用次数和响应时间

## 注意事项

1. 确保API服务正常运行
2. 合理配置缓存大小，避免内存占用过高
3. 定期更新内网CIDR配置
4. 监控API调用频率，避免过度请求 