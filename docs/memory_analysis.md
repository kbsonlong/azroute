# CoreDNS + hosts + azroute 插件内存使用分析

## 1. 概述
本分析文档针对企业内部大规模域名和网段场景，评估 CoreDNS 配合 hosts 插件和 azroute 插件的整体内存占用情况。

---

## 2. 主要内存结构

### 2.1 hosts 插件
- 将 hosts 文件全部加载到内存，通常用 `map[string][]net.IP` 结构存储。
- 每条记录包括：域名字符串、IP 地址、指针、map 结构开销。

### 2.2 azroute 插件
- 维护网段-AZ 映射（`a.AzMap`），并用 Trie（cidranger）结构索引所有网段。
- 新增 LRU 缓存（IP->AZ 映射，条目数可配置，默认1024）。
- Trie 结构和 LRU 缓存均为内存常驻结构。
- 每次查询时优先查 LRU，未命中再查 Trie，不产生额外持久内存分配。

---

## 3. 内存占用估算

### 3.1 hosts 插件
- 假设：
  - 域名数量：10,000
  - 每个域名平均 3 个 IP
  - 每条记录约 64 字节
- 计算：
  - 10,000 域名 × 3 IP = 30,000 条记录
  - 30,000 × 64 字节 ≈ 1.92 MB
- 放大一倍，**不超过 4MB**。

### 3.2 azroute 插件
- 假设：
  - 网段-AZ 映射 1000 条
  - 每条 AzMapEntry 约 64 字节
  - Trie（cidranger）结构额外开销约 2~3 倍映射数据（约 200KB）
  - LRU缓存容量 1024，平均每条约 64 字节
- 计算：
  - AzMapEntry: 1000 × 64 字节 = 64KB
  - Trie结构: 约 200KB
  - LRU缓存: 1024 × 64 字节 = 64KB
  - **合计约 330KB**
- 如果网段数增至 10,000，Trie 和 AzMapEntry 合计约 2MB，LRU缓存不变。
- LRU缓存最大占用 = lru_size × 单条entry大小（可配置，默认1024条，最大8K条也仅约0.5MB）。

### 3.3 CoreDNS 进程本身
- Go 运行时、其他插件、缓存等，通常几十 MB 起步。

---

## 4. 总体内存占用估算表

| 组件         | 10,000 域名 | 100,000 域名 |
|--------------|-------------|--------------|
| hosts 插件   | 2~4 MB      | 20~40 MB     |
| azroute 插件 | ~0.3 MB     | ~2 MB        |
| CoreDNS 进程 | 20~50 MB    | 20~50 MB     |
| **总计**     | 25~55 MB    | 45~90 MB     |

---

## 5. 结论与建议
- **即使有10万域名，整体内存消耗也远低于现代服务器的内存容量（GB级别），不会成为瓶颈。**
- azroute 插件的内存消耗极低，主要压力在 hosts 插件。
- Trie结构和LRU缓存极大提升了查找性能，且内存可控。
- 每次 DNS 查询不会产生持久内存分配，性能高效。
- 如有百万级域名，建议用自动化脚本/数据库生成 hosts 文件，或考虑专用权威 DNS 服务器。

---

## 6. 其他说明
- 可用 Go pprof 工具进一步分析实际运行时内存分布。
- Trie结构和LRU缓存的内存占用与配置参数直接相关，可根据实际业务灵活调整。
- 如需 Trie 优化、性能测试脚本等可进一步扩展。 